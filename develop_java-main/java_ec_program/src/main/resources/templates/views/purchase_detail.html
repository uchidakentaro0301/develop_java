<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>購入商品詳細画面</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/global.css}">
</head>
<body>
    <div class="container my-5">
        <h1 class="text-center mb-4">購入商品詳細</h1>

        <!-- カートが空の場合のエラーメッセージ -->
        <div th:if="${isCartEmpty}" class="alert alert-danger text-center">
            カートが空です。商品を追加してください。
            <div class="mt-3">
                <a href="/java_ec_program/views/product_list" class="btn btn-primary">商品一覧に戻る</a>
            </div>
        </div>
        
        <!-- 在庫不足時のエラーメッセージ表示 -->
        <div th:if="${stockInsufficient}" class="alert alert-danger text-center">
            <p th:text="${productError}">在庫不足のため購入できません。</p>
            <a href="/java_ec_program/views/product_list" class="btn btn-primary">商品一覧に戻る</a>
            
        </div>
		
        <!-- シナリオ1: 単品購入時の商品情報表示 -->
        <div class="purchase-details" th:if="${singleProduct != null}">
            <table class="table">
                <thead>
                    <tr>
                        <th>商品画像</th>
                        <th>商品名</th>
                        <th>価格</th>
                        <th>数量</th>
                        <th>小計</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
							<img th:src="${singleProduct.imgPath != null && !singleProduct.imgPath.isEmpty() ? singleProduct.imgPath : 'https://via.placeholder.com/450x300?text=No+Image'}" 
		                         class="card-img-top" alt="商品画像"
		                         onerror="this.onerror=null;this.src='https://via.placeholder.com/450x300?text=No+Image';">
                        </td>
                        <td th:text="${singleProduct.productName}">商品名</td>
                        <td th:text="${#numbers.formatDecimal(singleProduct.price * (1 + (singleProduct.includeTax / 100.0)), 0, 0)}">価格</td>
                        <td>
						    <form th:action="@{/views/purchase_detail}" method="post">
							    <input type="hidden" name="productId" th:value="${singleProduct.product_id}">
							    <select name="quantity" class="form-control" onchange="this.form.submit()">
							        <option th:each="i : ${#numbers.sequence(1, 10)}" th:value="${i}" th:text="${i}" th:selected="${i == quantity}"></option>
							    </select>
							</form>
						</td>
                        <td th:text="${#numbers.formatDecimal(singleProduct.price * quantity * (1 + (singleProduct.includeTax / 100.0)), 0, 0)}">小計</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- シナリオ2: カート内商品の情報表示 -->
        <div class="purchase-details" th:if="${singleProduct == null && !isCartEmpty}">
            <table class="table">
                <thead>
                    <tr>
                        <th>商品画像</th>
                        <th>商品名</th>
                        <th>価格</th>
                        <th>数量</th>
                        <th>小計</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="cartItem : ${cartItems}">
                        <td>
							<img th:src="${cartItem.product.imgPath != null && !cartItem.product.imgPath.isEmpty() ? cartItem.product.imgPath : 'https://via.placeholder.com/450x300?text=No+Image'}" 
		                         class="card-img-top" alt="商品画像"
		                         onerror="this.onerror=null;this.src='https://via.placeholder.com/450x300?text=No+Image';">
                        </td>
                        <td th:text="${cartItem.product.productName}">商品名</td>
                        <td th:text="${#numbers.formatDecimal(cartItem.product.price * (1 + (cartItem.product.includeTax / 100.0)), 0, 0)}">価格</td>
                        <td>
						    <form th:action="@{/views/purchase_detail}" method="post">
						        <input type="hidden" name="cartItemId" th:value="${cartItem.cartId}">
						        <select name="quantity" class="form-control" onchange="this.form.submit()">
						            <option th:each="i : ${#numbers.sequence(1, 10)}" th:value="${i}" th:text="${i}" th:selected="${i == cartItem.quantity}"></option>
						        </select>
						    </form>
						</td>
                        <td th:text="${#numbers.formatDecimal(cartItem.product.price * cartItem.quantity * (1 + (cartItem.product.includeTax / 100.0)), 0, 0)}">小計</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 合計金額表示 -->
        <div class="total-amount text-right" th:if="${singleProduct != null || !isCartEmpty}">
            <p>合計金額: <span th:text="${#numbers.formatDecimal(totalAmount, 0, 0)}">合計金額</span>円</p>
        </div>

        <!-- 受け取り情報入力フォーム -->
        <div class="receive-info my-4" th:if="${singleProduct != null || !isCartEmpty}">
            <h3 class="mb-3">受け取り情報</h3>
            <form th:action="@{/views/order_confirmation}" method="post">
                <!-- 名前 -->
                <div class="form-group">
                    <label for="name">お名前</label>
                    <input type="text" id="name" name="name" class="form-control" 
                           th:value="${userSession.user.userName ?: ''}" required>
                </div>

                <!-- メールアドレス -->
                <div class="form-group">
                    <label for="email">メールアドレス</label>
                    <input type="email" id="email" name="email" class="form-control"
                           th:value="${userSession.user.email ?: ''}" required>
                </div>

                <!-- 電話番号 -->
                <div class="form-group">
                    <label for="phone">電話番号</label>
                    <input type="text" id="phone" name="phone" class="form-control"
                           th:value="${userSession.user.phone ?: ''}" required>
                </div>

                <!-- カード情報 -->
			    <div class="form-group">
			        <label>カード情報を選択してください</label><br>
			        <div>
			            <input type="radio" id="card1" name="cardInfo" value="1234-5678-9012" checked="checked" >
			            <label for="card1">1234-5678-9012</label>
			        </div>
			        <div>
			            <input type="radio" id="newCardRadio" name="cardInfo" value="newCard">
			            <label for="newCardRadio">新しいカードを使用</label>
			            <input type="text" id="newCard" name="newCardNumber" class="form-control" maxlength="15" placeholder="例: 1234-5678-9012">
			        </div>
			        <!-- カード情報未選択のエラーメッセージ -->
			        <div th:if="${cardError != null}" class="text-danger">
			            <p th:text="${cardError}"></p>
			        </div>
			    </div>
			
			    <!-- 住所情報 -->
			    <div class="form-group">
			        <label>住所を選択してください</label><br>
			        <div>
			            <input type="radio" id="address1" name="addressInfo" value="群馬県高崎市請地町1-9" checked="checked" >
			            <label for="address1">群馬県高崎市請地町1-9</label>
			        </div>
			        <div>
			            <input type="radio" id="newAddressRadio" name="addressInfo" value="newAddress">
			            <label for="newAddressRadio">新しい住所を使用</label>
			            <input type="text" id="newAddress" name="newAddress" class="form-control" placeholder="例: 神奈川県横浜市南区10-11-12">
			        </div>
			        <!-- 住所未選択のエラーメッセージ -->
			        <div th:if="${addressError != null}" class="text-danger">
			            <p th:text="${addressError}"></p>
			        </div>
			    </div>
                <!-- productId と quantity を渡すための hidden フィールド -->
		        <input type="hidden" name="productId" th:value="${singleProduct != null ? singleProduct.product_id : ''}">
				<input type="hidden" name="quantity" th:value="${singleProduct != null ? quantity : ''}">
		
		        <!-- 購入確認ボタン -->
		        <div class="text-center">
		            <button type="submit" class="btn btn-primary">購入を確認</button>
		            <a href="/java_ec_program/views/cart_detail" class="btn btn-secondary">カートに戻る</a>
		        </div>
            </form>
        </div>
    </div>
</body>
</html>